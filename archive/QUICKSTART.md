# Quick Start Guide - Base Fork Development

## Prerequisites
```bash
# Check you have everything installed
forge --version
anvil --version
node --version
npm --version
psql --version
```

## Setup in 3 Steps

### 1. Configure Environment
```bash
# Edit .env and set your Base RPC URL
# You can use public RPC or get free API key from Alchemy/Infura
nano .env

# Set this:
BASE_RPC_URL=https://mainnet.base.org
# Or use Alchemy:
# BASE_RPC_URL=https://base-mainnet.g.alchemy.com/v2/YOUR_API_KEY
```

### 2. Start Fork & Deploy (3 separate terminals)

**Terminal 1: Start Fork**
```bash
npm run fork
```
Wait for "Listening on 127.0.0.1:8545"

**Terminal 2: Deploy & Fund**
```bash
# Deploy contracts to fork
npm run fork:deploy

# Fund test accounts with USDC/WETH
npm run fork:fund

# Load environment variables
source .env.local
```

**Terminal 3: Start Backend**
```bash
# Make sure PostgreSQL is running
npm run dev:backend
```

**Terminal 4: Start Frontend**
```bash
npm run dev:frontend
```

### 3. Test in Browser

Open http://localhost:3000

**Connect Wallet:**
- Use MetaMask or any wallet
- Add custom network:
  - Network Name: Base Fork
  - RPC URL: http://127.0.0.1:8545
  - Chain ID: 8453
  - Currency: ETH
- Import test account:
  - Private Key: `0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80`

## All-in-One Command

After initial setup, you can run everything at once:

```bash
# Terminal 1: Fork + Backend + Frontend
npm run dev

# Terminal 2: Deploy & fund (only first time)
npm run fork:setup && source .env.local
```

## Test the Gasless Flow

### As a Writer (LP)
1. Approve WETH for protocol
2. Create option offer (signs EIP-712 message)
3. Offer appears in orderbook

### As a Taker
1. Browse available options
2. Click "Buy Option"
3. Sign single EIP-3009 payment authorization (premium + $1 fee)
4. Backend submits transaction (you pay no gas!)
5. Receive option NFT

### Settlement
1. Wait for option to expire or be in-the-money
2. Click "Settle"
3. Sign settlement approval
4. CowSwap executes (gasless)
5. Receive profits in USDC

## Useful Commands

```bash
# Check balances
cast balance 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url http://127.0.0.1:8545

# Check USDC balance
cast call 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913 "balanceOf(address)(uint256)" 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 --rpc-url http://127.0.0.1:8545

# Mine a block
cast rpc evm_mine --rpc-url http://127.0.0.1:8545

# Fast forward time (1 day)
cast rpc evm_increaseTime 86400 --rpc-url http://127.0.0.1:8545
cast rpc evm_mine --rpc-url http://127.0.0.1:8545

# Reset fork
cast rpc anvil_reset --rpc-url http://127.0.0.1:8545
```

## Troubleshooting

**"insufficient funds for gas"**
- Make sure you're connected to fork (Chain ID 8453)
- Test account should have 10,000 ETH

**"USDC transfer failed"**
- Run `npm run fork:fund` to get test USDC

**Backend won't start**
- Check PostgreSQL is running: `sudo systemctl status postgresql`
- Check database exists: `psql -U postgres -c "\l"`

**Frontend can't find contract**
- Make sure you ran `npm run fork:deploy`
- Check `source .env.local` was run

## Environment Variables Summary

After setup, you should have:

**.env** (committed to git, template values)
```
BASE_RPC_URL=https://mainnet.base.org
```

**.env.local** (NOT committed, generated by fork:deploy)
```
NEXT_PUBLIC_PROTOCOL_ADDRESS=0x...
WETH_CONFIG_HASH=0x...
GAS_VAULT_ADDRESS=0x...
BROADCASTER_PRIVATE_KEY=0xac09...
```

## Next Steps

Once testing works on fork:
1. Read [FORK_SETUP.md](./FORK_SETUP.md) for advanced usage
2. Deploy to Base Sepolia testnet
3. Get testnet ETH and USDC
4. Test with real testnet
5. Deploy to Base mainnet

## Common Issues

**Port 8545 already in use**
```bash
# Find and kill process
lsof -ti:8545 | xargs kill -9
```

**Database connection error**
```bash
# Create database
psql -U postgres -c "CREATE DATABASE options_protocol;"
```

**Contracts won't compile**
```bash
# Install dependencies
forge install
forge build
```

Happy testing! ðŸš€
